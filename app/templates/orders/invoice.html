<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>æ˜ç´°æ›¸ #{{ order.id }}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: sans-serif;
        margin: 40px;
      }
      h1 {
        text-align: center;
        margin: 0 0 24px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 16px;
      }
      th,
      td {
        border: 1px solid #999;
        padding: 6px 8px;
        text-align: left;
      }
      th {
        background: #eee;
      }
      .right {
        text-align: right;
      }
      .button {
        display: inline-block;
        padding: 8px 16px;
        margin: 10px 0;
        font-size: 16px;
        text-align: center;
        background-color: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        transition: background-color 0.3s;
      }
      .button:hover {
        background-color: #0056b3;
      }
      .button:active {
        background-color: #004085;
      }
      .comment {
        margin-top: 10px;
        font-size: 14px;
        color: #555;
      }
      @media print {
        a#print-btn,
        a#setting-btn {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <a id="setting-btn" href="#" class="button" onclick="openSettingsModal()"
      >âš™ å†…å®¹è¨­å®š</a
    >
    <a id="print-btn" href="#" class="button" onclick="checkBeforePrint()"
      >ğŸ–¨ å°åˆ·</a
    >

    <h1>æ˜ç´°æ›¸</h1>

    <p>
      <strong>åŒ»ç™‚æ©Ÿé–¢å:</strong> <span id="clinic-name-display"></span><br />
      <strong>é›»è©±ç•ªå·:</strong> <span id="phone-number-display"></span><br />
      <strong>æ—¥ä»˜:</strong> {{ order.visit.visit_date }}<br />
      <strong>æ‚£è€…:</strong> {{ order.visit.patient.name }} (ã‚«ãƒ«ãƒ†ç•ªå· {{
      order.visit.patient.chart_number }})<br />
    </p>

    <table>
      <tr>
        <th style="width: 55%">è¨ºç™‚å†…å®¹</th>
        <th style="width: 15%" class="right">å˜ä¾¡</th>
        <th style="width: 15%" class="right">æ•°é‡</th>
        <th style="width: 15%" class="right">å°è¨ˆ</th>
      </tr>
      {% for it in order.items %}
      <tr>
        <td>{{ it.treatment.name }}</td>
        <td class="right">Â¥{{ it.treatment.price }}</td>
        <td class="right">{{ it.quantity }}</td>
        <td class="right">Â¥{{ it.subtotal }}</td>
      </tr>
      {% endfor %}
      <tr>
        <td colspan="3" class="right"><strong>åˆè¨ˆ</strong></td>
        <td class="right"><strong>Â¥{{ order.total_amount }}</strong></td>
      </tr>
    </table>

    <!-- ã‚³ãƒ¡ãƒ³ãƒˆéƒ¨åˆ†ã‚’ã“ã“ã«é…ç½® -->
    <div class="comment">
      <label for="comment-display">ã‚³ãƒ¡ãƒ³ãƒˆ:</label>
      <span id="comment-display">è‡ªç”±è¨ºç™‚ã«ã¤ãå¥åº·ä¿é™ºã¯é©å¿œã•ã‚Œã¾ã›ã‚“</span>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">å†…å®¹è¨­å®š</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="settings-form">
              <div class="mb-3">
                <label for="clinic-name" class="form-label">åŒ»ç™‚æ©Ÿé–¢å</label>
                <input type="text" class="form-control" id="clinic-name" />
              </div>
              <div class="mb-3">
                <label for="phone-number" class="form-label">é›»è©±ç•ªå·</label>
                <input type="text" class="form-control" id="phone-number" />
              </div>
              <div class="mb-3">
                <label for="comment" class="form-label">ã‚³ãƒ¡ãƒ³ãƒˆ</label>
                <textarea class="form-control" id="comment" rows="3">
è‡ªç”±è¨ºç™‚ã«ã¤ãå¥åº·ä¿é™ºã¯é©å¿œã•ã‚Œã¾ã›ã‚“</textarea
                >
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              é–‰ã˜ã‚‹
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="applyChanges()"
            >
              é©ç”¨
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- å°åˆ·å‰ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="confirmPrintModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">å†…å®¹è¨­å®šãŒæœªå®Œäº†ã§ã™</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p>å†…å®¹è¨­å®šãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚å°åˆ·ã‚’ç¶šã‘ã¾ã™ã‹ï¼Ÿ</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="button" onclick="printAnyway()">
              å°åˆ·ã‚’ç¶šã‘ã‚‹
            </button>
            <button
              type="button"
              class="button"
              onclick="openSettingsModalAndClosePrint()"
            >
              å†…å®¹è¨­å®šã‚’ã™ã‚‹
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let isContentSet = false;

      function openSettingsModal() {
        const modal = new bootstrap.Modal(
          document.getElementById("settingsModal")
        );
        modal.show();
      }

      function openSettingsModalAndClosePrint() {
        // å°åˆ·ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ã€è¨­å®šã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        bootstrap.Modal.getInstance(
          document.getElementById("confirmPrintModal")
        ).hide();
        openSettingsModal();
      }

      function applyChanges() {
        const name = document.getElementById("clinic-name").value;
        const phone = document.getElementById("phone-number").value;
        const comment = document.getElementById("comment").value;

        document.getElementById("clinic-name-display").innerText = name;
        document.getElementById("phone-number-display").innerText = phone;
        document.getElementById("comment-display").innerText = comment;

        isContentSet = true;
        bootstrap.Modal.getInstance(
          document.getElementById("settingsModal")
        ).hide();
      }

      function checkBeforePrint() {
        if (!isContentSet) {
          const modal = new bootstrap.Modal(
            document.getElementById("confirmPrintModal")
          );
          modal.show();
        } else {
          window.print();
        }
      }

      function printAnyway() {
        bootstrap.Modal.getInstance(
          document.getElementById("confirmPrintModal")
        ).hide();
        setTimeout(() => window.print(), 300);
      }
    </script>
  </body>
</html>
